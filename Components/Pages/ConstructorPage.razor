@page "/constructor/{ProductId:int}"
@rendermode InteractiveServer
@using GooseShop.Models
@using GooseShop.Data
@using GooseShop.Services
@using System.Text.Json
@using Microsoft.EntityFrameworkCore
@inject IJSRuntime JS
@inject AppDbContext DbContext
@inject CartService CartService
@inject NavigationManager Nav
@inject IWebHostEnvironment Env

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

<div class="container-fluid">
    <div class="row">
        @* Ліва панель: 3D Вікно *@
        <div class="col-md-8 p-0 bg-secondary" style="height: 85vh; min-height: 500px; position: relative;">
            <div id="threejs-container" style="width:100%; height:100%; cursor: crosshair;"></div>

            @if (isLoadingModel)
            {
                <div class="position-absolute top-50 start-50 translate-middle text-white text-center">
                    <div class="spinner-border" role="status"></div>
                    <p class="mt-2">Завантаження 3D сцени...</p>
                </div>
            }

            @* Плаваюча підказка для користувача *@
            <div class="position-absolute bottom-0 start-50 translate-middle-x mb-3">
                <div class="badge bg-dark bg-opacity-75 p-2 px-3 rounded-pill text-white shadow">
                    <i class="bi bi-cursor-fill me-2 text-warning"></i>
                    Тисніть на товар, щоб перемістити активний елемент
                </div>
            </div>
        </div>

        @* Права панель: Інструменти *@
        <div class="col-md-4 p-4 bg-light shadow-sm" style="height: 85vh; overflow-y: auto;">
            @if (product != null)
            {
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2 class="mb-0">Дизайн: @product.Name</h2>
                    <button class="btn btn-outline-danger btn-sm" @onclick='() => Nav.NavigateTo($"/product/{ProductId}")'>
                        <i class="bi bi-x-lg"></i>
                    </button>
                </div>

                @* Секція завантаження зображення *@
                <div class="card border-0 shadow-sm p-3 mb-4">
                    <label class="form-label fw-bold"><i class="bi bi-image-fill me-2 text-primary"></i>Ваші зображення:</label>
                    <InputFile OnChange="HandleFileUpload" class="form-control mb-2" />

                    @if (isUploading)
                    {
                        <div class="text-primary mt-1 small mb-2">
                            <span class="spinner-border spinner-border-sm"></span> Завантаження шару...
                        </div>
                    }

                    @* Список завантажених шарів *@
                    @if (uploadedLayers.Any())
                    {
                        <div class="mt-2">
                            <label class="small text-muted mb-2 d-block">Керування шарами:</label>
                            <div class="list-group list-group-flush border rounded mb-3">
                                @foreach (var layer in uploadedLayers)
                                {
                                    <div class="list-group-item d-flex align-items-center justify-content-between p-2">
                                        <div class="d-flex align-items-center">
                                            <img src="@layer.Url" class="rounded border me-2" style="width: 40px; height: 40px; object-fit: cover;" />
                                            <span class="small">Шар @(uploadedLayers.IndexOf(layer) + 1)</span>
                                        </div>
                                        <button class="btn btn-sm btn-link text-danger p-0" @onclick="() => RemoveSpecificLayer(layer.Id)">
                                            <i class="bi bi-trash3"></i>
                                        </button>
                                    </div>
                                }
                            </div>

                            <button class="btn btn-outline-secondary btn-sm w-100" @onclick="RemoveLastDecal">
                                <i class="bi bi-arrow-90deg-left me-1"></i> Скасувати останній крок
                            </button>
                        </div>
                    }
                    <div class="form-text mt-2 small text-muted">Клікніть по чашці, щоб виставити обране фото.</div>
                </div>

                @* Секція керування розміром *@
                <div class="card border-0 shadow-sm p-3 mb-4">
                    <label class="form-label fw-bold d-flex justify-content-between">
                        <span><i class="bi bi-arrows-fullscreen me-2"></i>Масштаб активного шару:</span>
                        <span class="badge bg-primary">@currentScale.ToString("F1")x</span>
                    </label>
                    <input type="range" min="0.2" max="2.5" step="0.1"
                           value="@currentScale.ToString().Replace(",", ".")"
                           @oninput="OnScaleChanged" class="form-range" />
                </div>

                @* Секція тексту *@
                <div class="card border-0 shadow-sm p-3 mb-4">
                    <label class="form-label fw-bold"><i class="bi bi-fonts me-2"></i>Додати напис:</label>
                    <div class="input-group">
                        <input @bind="customText" class="form-control" placeholder="Текст..." />
                        <input type="color" @bind="textColor" class="form-control form-control-color" style="max-width: 45px;" />
                        <button class="btn btn-primary" @onclick="Update3DDesign">Нанести</button>
                    </div>
                </div>

                <div class="mt-5 border-top pt-4">
                    <div class="d-flex justify-content-between h4 mb-4">
                        <span>Ціна:</span>
                        <span class="fw-bold text-success">@product.BasePrice грн</span>
                    </div>

                    <button class="btn btn-success btn-lg w-100 py-3 shadow fw-bold" @onclick="SaveAndAdd">
                        <i class="bi bi-cart-check-fill me-2"></i> В КОШИК
                    </button>
                </div>
            }
        </div>
    </div>
</div>


@code {
    [Parameter] public int ProductId { get; set; }

    private Product? product;
    private ProductConstructor? constructorConfig;
    private bool isLoadingModel = true;
    private bool isUploading = false;

    private string customText = "";
    private string textColor = "#000000";

    public class DecalLayer { public string Id { get; set; } = ""; public string Url { get; set; } = ""; }
    private List<DecalLayer> uploadedLayers = new();

    private string? lastUploadedImageUrl;
    private double currentScale = 1.0;
    private int quantity = 1;

    protected override async Task OnInitializedAsync()
    {
        product = await DbContext.Products.FindAsync(ProductId);
        constructorConfig = await DbContext.ProductConstructors
                                           .FirstOrDefaultAsync(c => c.ProductId == ProductId);

        if (product == null || constructorConfig == null) Nav.NavigateTo("/");
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && constructorConfig != null)
        {
            await JS.InvokeVoidAsync("init3DConstructor", "threejs-container", constructorConfig.ModelPath);
            isLoadingModel = false;
            StateHasChanged();
        }
    }

    private async Task OnScaleChanged(ChangeEventArgs e)
    {
        string val = e.Value?.ToString()?.Replace(",", ".") ?? "1.0";
        if (double.TryParse(val, System.Globalization.NumberStyles.Any, System.Globalization.CultureInfo.InvariantCulture, out double res))
        {
            currentScale = res;
            await JS.InvokeVoidAsync("updateModelScale", currentScale);
        }
    }

    private async Task Update3DDesign()
    {
        if (!string.IsNullOrEmpty(customText))
            await JS.InvokeVoidAsync("updateModelText", customText, textColor);
    }

    private async Task HandleFileUpload(InputFileChangeEventArgs e)
    {
        isUploading = true;
        try
        {
            var file = e.File;
            var fileName = $"{Guid.NewGuid()}{Path.GetExtension(file.Name)}";
            var path = Path.Combine(Env.WebRootPath, "uploads", fileName);

            Directory.CreateDirectory(Path.Combine(Env.WebRootPath, "uploads"));

            await using FileStream fs = new(path, FileMode.Create);
            await file.OpenReadStream(maxAllowedSize: 1024 * 1024 * 5).CopyToAsync(fs);

            var url = $"/uploads/{fileName}";

            // JS функція тепер повертає ID
            var decalId = await JS.InvokeAsync<string>("updateModelImage", url);

            uploadedLayers.Add(new DecalLayer { Id = decalId, Url = url });
            lastUploadedImageUrl = url;

            currentScale = 1.0;
        }
        catch (Exception ex) { Console.WriteLine(ex.Message); }
        finally { isUploading = false; }
    }

    private async Task RemoveSpecificLayer(string id)
    {
        await JS.InvokeVoidAsync("removeSpecificDecal", id);
        uploadedLayers.RemoveAll(x => x.Id == id);
        StateHasChanged();
    }

    private async Task RemoveLastDecal()
    {
        if (uploadedLayers.Any())
        {
            var last = uploadedLayers.Last();
            await JS.InvokeVoidAsync("removeSpecificDecal", last.Id);
            uploadedLayers.Remove(last);
            StateHasChanged();
        }
    }

    private async Task SaveAndAdd()
    {
        // Отримуємо повний стан (координати, повороти, масштаби)
        var threeJsState = await JS.InvokeAsync<string>("getConstructorState");

        var config = new
        {
            Text = customText,
            Color = textColor,
            State = threeJsState, // Це JSON-масив для 3D відтворення в адмінці
            Layers = uploadedLayers, // Список об'єктів {Id, Url}
            ModelType = constructorConfig?.Type.ToString()
        };

        string json = JsonSerializer.Serialize(config);
        
        // Передаємо в кошик: перше фото зі списку буде іконкою
        string? previewUrl = uploadedLayers.FirstOrDefault()?.Url;
        
        CartService.AddToCart(product!, json, previewUrl, quantity);
        Nav.NavigateTo("/cart");
    }
}