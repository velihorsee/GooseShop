@page "/"
@using GooseShop.Models
@using GooseShop.Services
@inject ProductService ProductService
@inject NavigationManager Nav
@inject IJSRuntime JS

@* --- ЕПІЧНИЙ ХАЙП-БАННЕР --- *@
<div class="container-fluid px-lg-5 mt-4">
    <div class="z-hero-card">
        <div class="row align-items-center g-0" style="height: 100%; min-height: 400px;">
            @* ЛІВА ЧАСТИНА: КОНТЕНТ *@
            <div class="col-lg-7 p-4 p-md-5" style="z-index: 2;">
                <div class="z-badge mb-3 shadow-pixel">#ГУСЬ_ГЕНГ_2026 🦢</div>
                <h1 class="fw-black display-2 text-uppercase m-0 lh-1">
                    ТВІЙ МЕРЧ — <br /> <span class="text-white outline-hero">ТВІЙ ВАЙБ.</span>
                </h1>
                <p class="fs-4 fw-bold mt-3 text-dark">Створи унікальну чашку або футболку за 30 секунд. 🍌</p>
                <div class="z-hero-actions d-flex gap-3 mt-4 flex-wrap">
                    <button class="z-btn z-btn-cyan shadow-pixel" @onclick='() => Nav.NavigateTo("/constructor/1")'>ХОЧУ ЧАШКУ 🔥</button>
                    <button class="z-btn z-btn-yellow shadow-pixel" @onclick='() => ScrollTo("product-catalog")'>КАТАЛОГ 📜</button>
                </div>
            </div>

            @* ПРАВА ЧАСТИНА: ГУСАК *@
            <div class="col-lg-5 position-relative d-none d-lg-block" style="height: 400px;">
                <div id="guard-goose" class="z-guard-goose-v4">
                    <div class="goose-krya-badge">КРЯ</div>
                    <div class="goose-head-v4">
                        <div class="goose-eye-v4 eye-l">
                            <div class="eye-lid-v4"></div>
                            <div class="goose-pupil"></div>
                        </div>
                        <div class="goose-eye-v4 eye-r">
                            <div class="eye-lid-v4"></div>
                            <div class="goose-pupil"></div>
                        </div>
                        <div class="goose-beak-v4">
                            <div class="beak-nostril-v4"></div>
                        </div>
                    </div>
                    <div class="goose-neck-v4">
                        <div class="neck-crease"></div>
                        <div class="neck-crease"></div>
                        <div class="neck-crease"></div>
                        <div class="neck-crease"></div>
                    </div>
                    <div class="goose-body-v4"></div>
                </div>
            </div>
        </div>
    </div>
</div>

@* --- КАТАЛОГ ТОВАРІВ --- *@
<div class="container-fluid px-lg-5 my-5 pt-5" id="product-catalog">
    <h2 class="fw-black display-4 text-uppercase mb-5">ТОП <span class="z-highlight px-3 shadow-pixel">ДРОПИ</span></h2>

    @if (pagedProducts == null)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-dark" style="width: 3rem; height: 3rem; border-width: 0.5rem;"></div>
        </div>
    }
    else
    {
        <div class="row row-cols-1 row-cols-md-3 row-cols-xl-4 g-5">
            @foreach (var p in pagedProducts)
            {
                <div class="col">
                    <div class="z-item-card shadow-pixel">
                        @* 1. Основне посилання (Картинка та назва) *@
                        <a href="/product/@p.Id" class="text-decoration-none d-block">
                            <div class="z-img-box">
                                @{
                                    var img = string.IsNullOrEmpty(p.ImageUrl) ? "images/placeholder.jpg" : p.ImageUrl.TrimStart('/');
                                }
                                <img src="/@img" onerror="this.src='/images/placeholder.jpg';" alt="@p.Name" />

                                @if (p.BasePrice > 1000)
                                {
                                    <div class="z-card-badge shadow-pixel">🔥 TOP</div>
                                }
                            </div>
                            <div class="p-4 bg-white">
                                <h4 class="fw-black text-uppercase text-truncate mb-1 text-dark">@p.Name</h4>
                            </div>
                        </a>

                        @* 2. Блок дій (Ціна та Кнопка) *@
                        <div class="px-4 pb-4 d-flex justify-content-between align-items-center mt-auto">
                            <a href="/product/@p.Id" class="text-decoration-none">
                                <div class="z-price-pill shadow-pixel">
                                    @p.BasePrice <span class="small">ГРН</span>
                                </div>
                            </a>

                            <button class="z-buy-btn-full shadow-pixel" @onclick='() => Nav.NavigateTo($"/product/{p.Id}")'>
                                КУПИТИ
                            </button>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
</div>

@code {
    private List<Product>? allProducts;
    private List<Product>? pagedProducts;
    private int pageSize = 20;

    protected override async Task OnInitializedAsync()
    {
        allProducts = await ProductService.GetAllProductsAsync();
        UpdatePagedResults();
    }

    private void UpdatePagedResults() => pagedProducts = allProducts?.Take(pageSize).ToList();
    private async Task ScrollTo(string id) => await JS.InvokeVoidAsync("scrollToElement", id);

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await JS.InvokeVoidAsync("initGooseRain");
            //await JS.InvokeVoidAsync("initSmartGoose", "heroGoose");
            await JS.InvokeVoidAsync("initGuardGoose");
        }
    }
}